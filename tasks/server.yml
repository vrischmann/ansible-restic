- name: create the config directory
  file:
    dest: "{{ restic_conf_directory }}"
    owner: root
    group: root
    mode: 0700
    state: directory

- name: add the service
  template:
    src: server/restic-backup.service.j2
    dest: "/etc/systemd/system/restic-backup-{{ item.name }}.service"
    owner: root
    group: root
    mode: 0644
  with_items: "{{ restic_backups }}"

- name: add the timer
  template:
    src: restic-backup.timer.j2
    dest: "/etc/systemd/system/restic-backup-{{ item.name }}.timer"
    owner: root
    group: root
    mode: 0644
  with_items: "{{ restic_backups }}"

- name: create the environment file
  template:
    src: env.j2
    dest: "{{ restic_conf_directory }}/{{ item.name }}.env"
    owner: root
    group: root
    mode: 0600
  with_items: "{{ restic_backups }}"

- name: create the files file
  template:
    src: files.j2
    dest: "{{ restic_conf_directory }}/files"
    owner: root
    group: root
    mode: 0600

- name: create the excludes file
  template:
    src: excludes.j2
    dest: "{{ restic_conf_directory }}/excludes"
    owner: root
    group: root
    mode: 0600

- name: enable the service
  systemd:
    daemon_reload: yes
    name: "restic-backup-{{ item.name }}"
    enabled: yes # NOTE(vincent): do _not_ start the service here or it will just execute the backup !
  with_items: "{{ restic_backups }}"

- name: enable the service timers
  systemd:
    daemon_reload: yes
    name: "restic-backup-{{ item.name }}.timer"
    enabled: yes
    state: started
  with_items: "{{ restic_backups }}"
